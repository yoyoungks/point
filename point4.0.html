<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€ç»´æ°”æ³¡ - æ‰‹æœºç¬”è®°</title>
    <meta name="theme-color" content="#1a1a1a">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .header {
            padding: 15px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .theme-selector {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        /* ä¸»ç”»å¸ƒåŒºåŸŸ */
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            touch-action: none;
        }
        
        #bubble-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* åº•éƒ¨è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 15px;
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid #333;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        #text-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        #text-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        #create-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 500;
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            position: absolute;
            bottom: 80px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ä¸»é¢˜ç®¡ç†é¢æ¿ */
        .theme-panel {
            position: absolute;
            top: 0;
            left: -100%;
            width: 80%;
            height: 100%;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(30px);
            transition: left 0.3s ease;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .theme-panel.active {
            left: 0;
        }
        
        .theme-item {
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border-left: 4px solid #fff;
        }
        
        .new-theme-btn {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            margin-top: 10px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .header {
                padding: 12px 15px;
            }
            
            .input-area {
                padding: 12px 15px;
            }
            
            .control-btn {
                width: 45px;
                height: 45px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <div class="header">
            <h1>æ€ç»´æ°”æ³¡</h1>
            <select class="theme-selector" id="theme-selector">
                <option value="default">é»˜è®¤ä¸»é¢˜</option>
            </select>
        </div>
        
        <!-- ä¸»ç”»å¸ƒ -->
        <div class="canvas-container">
            <canvas id="bubble-canvas"></canvas>
            
            <!-- æ§åˆ¶æŒ‰é’® -->
            <div class="controls">
                <button class="control-btn" id="zoom-in">+</button>
                <button class="control-btn" id="zoom-out">-</button>
                <button class="control-btn" id="theme-btn">ğŸ“</button>
                <button class="control-btn" id="export-btn">ğŸ“¤</button>
            </div>
        </div>
        
        <!-- åº•éƒ¨è¾“å…¥ -->
        <div class="input-area">
            <div class="input-group">
                <input type="text" id="text-input" placeholder="è¾“å…¥æ‚¨çš„æƒ³æ³•...">
                <button id="create-btn">æ·»åŠ </button>
            </div>
        </div>
        
        <!-- ä¸»é¢˜ç®¡ç†é¢æ¿ -->
        <div class="theme-panel" id="theme-panel">
            <h2>ä¸»é¢˜ç®¡ç†</h2>
            <div id="theme-list">
                <!-- ä¸»é¢˜åˆ—è¡¨ä¼šåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button class="new-theme-btn" id="new-theme-btn">æ–°å»ºä¸»é¢˜</button>
        </div>
    </div>

    <script>
        // æ€ç»´æ°”æ³¡æ‰‹æœºAPP
        class MobileBubbleApp {
            constructor() {
                this.themes = new Map();
                this.currentTheme = 'default';
                this.scale = 1.0;
                this.offset = { x: 0, y: 0 };
                this.isDragging = false;
                this.lastTouch = null;
                
                this.init();
            }
            
            async init() {
                // è®¾ç½®Canvas
                this.canvas = document.getElementById('bubble-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.resizeCanvas();
                
                // åŠ è½½æ•°æ®
                await this.loadData();
                
                // è®¾ç½®äº‹ä»¶ç›‘å¬
                this.setupEventListeners();
                
                // å¼€å§‹åŠ¨ç”»
                this.animate();
            }
            
            // è°ƒæ•´Canvaså¤§å°
            resizeCanvas() {
                this.canvas.width = window.innerWidth * window.devicePixelRatio;
                this.canvas.height = window.innerHeight * window.devicePixelRatio;
                this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            }
            
            // åŠ è½½æœ¬åœ°æ•°æ®
            async loadData() {
                const saved = localStorage.getItem('mobileBubbleThemes');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.themes = new Map(data);
                } else {
                    // åˆ›å»ºé»˜è®¤ä¸»é¢˜
                    this.createTheme('default', 'é»˜è®¤ä¸»é¢˜');
                }
                
                this.updateThemeSelector();
            }
            
            // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
            saveData() {
                const data = JSON.stringify([...this.themes]);
                localStorage.setItem('mobileBubbleThemes', data);
            }
            
            // åˆ›å»ºæ–°ä¸»é¢˜
            createTheme(id, name) {
                const theme = {
                    id,
                    name,
                    bubbles: [],
                    created: new Date().toISOString()
                };
                this.themes.set(id, theme);
                this.saveData();
                this.updateThemeSelector();
                return theme;
            }
            
            // æ›´æ–°ä¸»é¢˜é€‰æ‹©å™¨
            updateThemeSelector() {
                const selector = document.getElementById('theme-selector');
                const themeList = document.getElementById('theme-list');
                
                // æ¸…ç©ºé€‰é¡¹
                selector.innerHTML = '';
                themeList.innerHTML = '';
                
                // æ·»åŠ ä¸»é¢˜é€‰é¡¹
                this.themes.forEach((theme, id) => {
                    // é€‰æ‹©å™¨é€‰é¡¹
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = theme.name;
                    option.selected = id === this.currentTheme;
                    selector.appendChild(option);
                    
                    // ä¸»é¢˜é¢æ¿é¡¹ç›®
                    const themeItem = document.createElement('div');
                    themeItem.className = 'theme-item';
                    themeItem.innerHTML = `
                        <h3>${theme.name}</h3>
                        <p>${theme.bubbles.length} ä¸ªæ°”æ³¡</p>
                    `;
                    themeItem.addEventListener('click', () => {
                        this.switchTheme(id);
                        this.hideThemePanel();
                    });
                    themeList.appendChild(themeItem);
                });
            }
            
            // åˆ‡æ¢ä¸»é¢˜
            switchTheme(themeId) {
                this.currentTheme = themeId;
                this.render();
            }
            
            // æ·»åŠ æ°”æ³¡
            addBubble(content) {
                if (!content.trim()) return;
                
                const theme = this.themes.get(this.currentTheme);
                if (!theme) return;
                
                // è®¡ç®—ä½ç½®ï¼ˆåœ¨å±å¹•ä¸­å¤®é™„è¿‘ï¼‰
                const x = window.innerWidth / 2 + (Math.random() - 0.5) * 100;
                const y = window.innerHeight / 2 + (Math.random() - 0.5) * 100;
                
                const bubble = {
                    id: 'bubble_' + Date.now(),
                    content,
                    position: { x, y },
                    size: this.calculateSize(content),
                    created: new Date().toISOString()
                };
                
                theme.bubbles.push(bubble);
                this.saveData();
                this.render();
            }
            
            // æ ¹æ®å†…å®¹è®¡ç®—æ°”æ³¡å¤§å°
            calculateSize(content) {
                const length = content.length;
                if (length <= 10) return 'small';
                if (length <= 20) return 'medium';
                if (length <= 30) return 'large';
                return 'xlarge';
            }
            
            // æ˜¾ç¤ºä¸»é¢˜é¢æ¿
            showThemePanel() {
                document.getElementById('theme-panel').classList.add('active');
            }
            
            // éšè—ä¸»é¢˜é¢æ¿
            hideThemePanel() {
                document.getElementById('theme-panel').classList.remove('active');
            }
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬
            setupEventListeners() {
                // çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', () => {
                    this.resizeCanvas();
                    this.render();
                });
                
                // æ·»åŠ æ°”æ³¡æŒ‰é’®
                document.getElementById('create-btn').addEventListener('click', () => {
                    const input = document.getElementById('text-input');
                    this.addBubble(input.value);
                    input.value = '';
                    input.focus();
                });
                
                // å›è½¦é”®æ·»åŠ æ°”æ³¡
                document.getElementById('text-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('create-btn').click();
                    }
                });
                
                // ç¼©æ”¾æ§åˆ¶
                document.getElementById('zoom-in').addEventListener('click', () => {
                    this.scale *= 1.2;
                    this.render();
                });
                
                document.getElementById('zoom-out').addEventListener('click', () => {
                    this.scale /= 1.2;
                    this.render();
                });
                
                // ä¸»é¢˜ç®¡ç†
                document.getElementById('theme-btn').addEventListener('click', () => {
                    this.showThemePanel();
                });
                
                document.getElementById('theme-selector').addEventListener('change', (e) => {
                    this.switchTheme(e.target.value);
                });
                
                document.getElementById('new-theme-btn').addEventListener('click', () => {
                    const name = prompt('è¯·è¾“å…¥æ–°ä¸»é¢˜åç§°:');
                    if (name) {
                        const id = 'theme_' + Date.now();
                        this.createTheme(id, name);
                        this.switchTheme(id);
                        this.hideThemePanel();
                    }
                });
                
                // å¯¼å‡ºåŠŸèƒ½
                document.getElementById('export-btn').addEventListener('click', () => {
                    this.exportData();
                });
                
                // è§¦æ‘¸äº‹ä»¶ - æ‹–æ‹½ç”»å¸ƒ
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (e.touches.length === 1) {
                        this.isDragging = true;
                        this.lastTouch = {
                            x: e.touches[0].clientX,
                            y: e.touches[0].clientY
                        };
                    }
                });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (this.isDragging && e.touches.length === 1) {
                        const touch = e.touches[0];
                        const dx = touch.clientX - this.lastTouch.x;
                        const dy = touch.clientY - this.lastTouch.y;
                        
                        this.offset.x += dx;
                        this.offset.y += dy;
                        
                        this.lastTouch = {
                            x: touch.clientX,
                            y: touch.clientY
                        };
                        
                        this.render();
                    }
                });
                
                this.canvas.addEventListener('touchend', () => {
                    this.isDragging = false;
                });
                
                // åŒå‡»é‡ç½®è§†å›¾
                this.canvas.addEventListener('dblclick', () => {
                    this.scale = 1.0;
                    this.offset = { x: 0, y: 0 };
                    this.render();
                });
            }
            
            // æ¸²æŸ“æ°”æ³¡
            render() {
                const theme = this.themes.get(this.currentTheme);
                if (!theme) return;
                
                // æ¸…é™¤ç”»å¸ƒ
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // åº”ç”¨å˜æ¢
                this.ctx.save();
                this.ctx.translate(this.offset.x, this.offset.y);
                this.ctx.scale(this.scale, this.scale);
                
                // ç»˜åˆ¶æ°”æ³¡
                theme.bubbles.forEach(bubble => {
                    this.drawBubble(bubble);
                });
                
                this.ctx.restore();
            }
            
            // ç»˜åˆ¶å•ä¸ªæ°”æ³¡
            drawBubble(bubble) {
                const { position, content, size } = bubble;
                
                // æ ¹æ®å¤§å°è®¾ç½®åŠå¾„
                let radius;
                switch(size) {
                    case 'small': radius = 40; break;
                    case 'medium': radius = 60; break;
                    case 'large': radius = 80; break;
                    case 'xlarge': radius = 100; break;
                    default: radius = 60;
                }
                
                this.ctx.save();
                this.ctx.translate(position.x, position.y);
                
                // ç»˜åˆ¶æ°”æ³¡é˜´å½±
                this.ctx.beginPath();
                this.ctx.arc(0, 0, radius + 3, 0, Math.PI * 2);
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                this.ctx.fill();
                
                // ç»˜åˆ¶æ°”æ³¡
                this.ctx.beginPath();
                this.ctx.arc(0, 0, radius, 0, Math.PI * 2);
                
                // æ¸å˜å¡«å……
                const gradient = this.ctx.createRadialGradient(
                    -radius * 0.3, -radius * 0.3, 0,
                    0, 0, radius
                );
                gradient.addColorStop(0, 'rgba(255, 255, 255, 0.3)');
                gradient.addColorStop(1, 'rgba(200, 200, 200, 0.1)');
                
                this.ctx.fillStyle = gradient;
                this.ctx.fill();
                
                // è¾¹æ¡†
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                this.ctx.lineWidth = 1;
                this.ctx.stroke();
                
                // ç»˜åˆ¶æ–‡å­—
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                
                // æ ¹æ®æ°”æ³¡å¤§å°è°ƒæ•´å­—ä½“
                let fontSize;
                if (size === 'small') fontSize = 12;
                else if (size === 'medium') fontSize = 14;
                else if (size === 'large') fontSize = 16;
                else fontSize = 14;
                
                this.ctx.font = `${fontSize}px -apple-system, BlinkMacSystemFont`;
                
                // æ–‡å­—æ¢è¡Œ
                const maxWidth = radius * 1.6;
                const words = content.split('');
                let line = '';
                const lines = [];
                
                for (let i = 0; i < words.length; i++) {
                    const testLine = line + words[i];
                    const metrics = this.ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && line !== '') {
                        lines.push(line);
                        line = words[i];
                    } else {
                        line = testLine;
                    }
                }
                lines.push(line);
                
                // ç»˜åˆ¶å¤šè¡Œæ–‡å­—
                const lineHeight = fontSize + 2;
                const startY = -((lines.length - 1) * lineHeight) / 2;
                
                lines.forEach((line, i) => {
                    this.ctx.fillText(line, 0, startY + i * lineHeight);
                });
                
                this.ctx.restore();
            }
            
            // å¯¼å‡ºæ•°æ®
            exportData() {
                const theme = this.themes.get(this.currentTheme);
                if (!theme || theme.bubbles.length === 0) {
                    alert('å½“å‰ä¸»é¢˜æ²¡æœ‰æ°”æ³¡å¯å¯¼å‡º');
                    return;
                }
                
                const text = theme.bubbles.map(bubble => bubble.content).join('\n');
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                // åœ¨ç§»åŠ¨ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä¸‹è½½æˆ–åˆ†äº«
                if (navigator.share) {
                    // ä½¿ç”¨Web Share API
                    navigator.share({
                        title: `æ€ç»´æ°”æ³¡ - ${theme.name}`,
                        text: text
                    });
                } else {
                    // ä¼ ç»Ÿä¸‹è½½æ–¹å¼
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `æ€ç»´æ°”æ³¡-${theme.name}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
                
                URL.revokeObjectURL(url);
            }
            
            // åŠ¨ç”»å¾ªç¯
            animate() {
                this.render();
                requestAnimationFrame(() => this.animate());
            }
        }
        
        // å¯åŠ¨åº”ç”¨
        const app = new MobileBubbleApp();
        
        // PWAç›¸å…³ä»£ç 
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(() => {
                console.log('Service Worker æ³¨å†ŒæˆåŠŸ');
            });
        }
        
        // æ·»åŠ åˆ°ä¸»å±å¹•æç¤º
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºå®‰è£…æç¤º
        });
    </script>
</body>
</html>